# PRD-02: kubelet 및 사용자 정의 헬스체크 제외를 통한 노이즈 감소

## 배경
- 현 에이전트는 `kprobe/tcp_v4_connect` 기준으로 모든 outbound connect 시도를 카운트함.
- kubelet 프로브(TCP/HTTP) 및 일반 앱의 헬스체크(ping 유사)가 카운트에 포함되어 의도치 않은 스케일 트리거를 유발할 수 있음.

## 목표
- kubelet 프로브 및 사용자 정의 헬스체크 트래픽을 카운트/스케일 트리거에서 제외한다.
- 제외 리스트를 런타임 환경변수로 설정 가능하게 한다.
- 실제 비즈니스 트래픽은 기존대로 감지·카운트한다.

## 설계
1) eBPF 이벤트 확장
   - 기존 `event{ daddr u32 }`에 `pid u32`(tgid), `comm char[16]`, `dport u16`(네트워크 바이트 오더) 추가.
2) 유저 공간 필터(선택)
   - env 기반 제외 리스트: `EXCLUDE_COMMS`(쉼표 구분, 기본 `kubelet`), `EXCLUDE_PIDS`(옵션), `EXCLUDE_PORTS`(옵션, dport 기준), `EXCLUDE_NAMESPACES`(옵션, 매핑 후 ns 기준).
   - ringbuf 이벤트 수신 시 comm/pid/dport/namespace가 제외 리스트에 해당되면 사용자 공간에서 카운트만 스킵(필요 시 로그). eBPF는 단순히 메타데이터를 올려주도록 유지.
3) 기본값
   - `EXCLUDE_COMMS=kubelet` 기본 적용.
   - 필요 시 사용자 헬스체크 프로세스명/포트/네임스페이스를 env로 추가해 노이즈 제거.
4) 리스크/제한
   - comm/pid는 프로세스명 공유/변경 시 오탐/누락 가능. 포트/네임스페이스 제외는 필터 과잉 시 실제 트래픽 누락 위험.
   - TCP connect 시점에는 페이로드/헤더 정보가 없어 “ping 유사 헬스체크”를 정확히 식별하기 어렵다. 현실적 기준은 comm/pid/포트/네임스페이스 메타데이터뿐이며 과소/과대 필터 가능성 존재.
   - 이벤트 크기 증가로 ringbuf 사용량 소폭 상승. bpf2go 산출물 재생성 필요.

## 추천 추가 사항
- 포트/네임스페이스 제외 옵션: `EXCLUDE_PORTS`, `EXCLUDE_NAMESPACES`를 추가해 헬스체크 전용 포트/서비스를 명시적으로 제외할 수 있게 한다.
- Prometheus 스크레이프 충돌 방지: hostNetwork 사용 시 기본 포트를 9102로 유지하고, 충돌 시 `METRICS_ADDR`로 변경할 수 있게 문서화/디폴트 설정 반영.
- headless/Pod IP 호출 한계: 파드 0개인 headless 호출은 감지 불가하므로, zero-scale 대상은 ClusterIP 경로로 유도하거나 별도 “wakeup” ClusterIP를 마련하도록 가이드한다.
- L7 eBPF로 헬스체크 패턴을 자동 식별하는 것은 현실적으로 어렵다(TLS로 페이로드 불가, 프로토콜 파서·verifier 리스크·성능 부담). 필요한 경우 서비스메시/인그레스/사이드카 등 L7 프록시 계층에서 헤더/경로 기반 필터링을 병행한다.

## 작업 항목
1. eBPF 이벤트 구조체에 `pid`/`comm`/`dport` 추가 후 ringbuf로 전달, bpf2go 산출물 재생성.
2. Go 에이전트에서 env(`EXCLUDE_COMMS`, `EXCLUDE_PIDS`, 옵션 `EXCLUDE_PORTS`, `EXCLUDE_NAMESPACES`) 파싱 후 사용자 공간 필터 적용.
3. README/매니페스트에 제외 옵션과 기본값(`EXCLUDE_COMMS=kubelet`) 문서화, `METRICS_ADDR` 기본 9102 안내 유지.
4. 동작 검증: kubelet 프로브/커스텀 헬스체크 트래픽에서 카운트가 증가하지 않는지, 일반 내부 트래픽은 기존대로 카운트되는지 확인.
